name: Auto Generate and Deploy

on:
  # 1. ìŠ¤ì¼€ì¤„ì— ë”°ë¼ ìë™ ì‹¤í–‰
  schedule:
    # UTC ê¸°ì¤€ ë§¤ì¼ 0ì‹œ, 5ì‹œ, 10ì‹œ, 15ì‹œ, 20ì‹œì— ì‹¤í–‰ (í•œêµ­ ì‹œê°„: ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 2ì‹œ, ì €ë… 7ì‹œ, ë°¤ 12ì‹œ, ìƒˆë²½ 5ì‹œ)
    - cron: '0 0,5,10,15,20 * * *'
  
  # 2. ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë²„íŠ¼ ì¶”ê°€
  workflow_dispatch:

jobs:
  build-and-deploy:
    # ğŸ”¥ Git Pushë¥¼ ìœ„í•œ ì“°ê¸° ê¶Œí•œ ë¶€ì—¬
    permissions:
      contents: write

    runs-on: ubuntu-latest # ê°€ìƒ ì»´í“¨í„° í™˜ê²½: ìš°ë¶„íˆ¬ ìµœì‹  ë²„ì „

    steps:
      # 1. ì €ì¥ì†Œ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Node.js í™˜ê²½ ì„¤ì • (v20 ì‚¬ìš©)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # npm ì˜ì¡´ì„± ìºì‹±ìœ¼ë¡œ ì†ë„ í–¥ìƒ

      # 3. í”„ë¡œì íŠ¸ ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm install

      # 4. í¬ìŠ¤íŠ¸ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ì¿ íŒ¡ API í‚¤ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì£¼ì…)
      - name: Generate new posts
        run: node autoAddPostsFromCoupang.js
        env:
          COUPANG_ACCESS_KEY: ${{ secrets.COUPANG_ACCESS_KEY }}
          COUPANG_SECRET_KEY: ${{ secrets.COUPANG_SECRET_KEY }}

      # 5. ì›¹ì‚¬ì´íŠ¸ íŒŒì¼ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      # 5. ë³€ê²½ëœ postsData.json íŒŒì¼ì„ Gitì— ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add postsData.json
          # ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹
          if ! git diff --staged --quiet; then
            git commit -m "chore: postsData.json ìë™ ì—…ë°ì´íŠ¸"
            git push
          else
            echo "postsData.jsonì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      # 6. ì›¹ì‚¬ì´íŠ¸ íŒŒì¼ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Build static site
        run: node generate.js

      # 6. Firebaseì— ë°°í¬
      # 7. Firebaseì— ë°°í¬
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
